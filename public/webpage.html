<!DOCTYPE html>
<html>
<head>
    <title>Social Media API Tester</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: Arial, sans-serif; 
            background: #f5f5f5;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .container { display: flex; gap: 20px; }
        .sidebar { flex: 1; }
        .main { flex: 2; }
        .card { 
            background: white; 
            border-radius: 10px; 
            padding: 20px; 
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; margin-bottom: 20px; }
        h2 { color: #555; margin-bottom: 15px; }
        h3 { color: #666; margin-bottom: 10px; }
        
        input, textarea, button { 
            width: 100%; 
            padding: 10px; 
            margin: 5px 0; 
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover { background: #0056b3; }
        button.secondary { background: #6c757d; }
        button.secondary:hover { background: #545b62; }
        
        .response { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 5px; 
            margin-top: 10px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .user-info { 
            background: #e7f3ff; 
            padding: 10px; 
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .post { 
            border: 1px solid #eee; 
            padding: 15px; 
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .notification { 
            background: #fff3cd; 
            padding: 10px; 
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
        }
    </style>
</head>
<body>
    <h1>Social Media API Tester</h1>
    
    <div class="container">
        <div class="sidebar">
            <div class="card">
                <h2>Authentication</h2>
                
                <h3>Register</h3>
                <input type="text" id="regUsername" placeholder="Username">
                <input type="email" id="regEmail" placeholder="Email">
                <input type="password" id="regPassword" placeholder="Password">
                <button onclick="register()">Register</button>
                <div id="registerResponse" class="response"></div>

                <h3>Login</h3>
                <input type="email" id="loginEmail" placeholder="Email">
                <input type="password" id="loginPassword" placeholder="Password">
                <button onclick="login()">Login</button>
                <div id="loginResponse" class="response"></div>
                
                <div id="userInfo" class="user-info" style="display: none;">
                    <strong>Logged in as:</strong>
                    <span id="currentUser"></span>
                    <button onclick="logout()" class="secondary" style="margin-top: 10px;">Logout</button>
                </div>
            </div>

            <div class="card">
                <h2>Users</h2>
                <input type="number" id="profileUserId" placeholder="User ID" value="1">
                <button onclick="getUserProfile()">Get Profile</button>
                
                <input type="number" id="followUserId" placeholder="User ID to follow">
                <button onclick="followUser()">Follow/Unfollow</button>
                
                <div id="userProfileResponse" class="response"></div>
            </div>

            <div class="card">
                <h2>Notifications</h2>
                <button onclick="getNotifications()">Get Notifications</button>
                <button onclick="markAllRead()" class="secondary">Mark All Read</button>
                <div id="notificationsResponse" class="response"></div>
            </div>
        </div>

        <div class="main">
            <div class="card">
                <h2>Posts</h2>
                <textarea id="postContent" placeholder="What's on your mind?" rows="3"></textarea>
                <button onclick="createPost()">Create Post</button>
                
                <div style="margin: 10px 0; display: flex; gap: 10px; align-items: center;">
                    <span>Page:</span>
                    <input type="number" id="postsPage" value="1" min="1" style="width: 60px;">
                    <span>Limit:</span>
                    <input type="number" id="postsLimit" value="10" min="1" max="50" style="width: 60px;">
                    <button onclick="getAllPosts()" class="secondary">Get Posts</button>
                </div>

                <div style="margin: 5px 0;">
                    <button onclick="previousPage('posts')" class="secondary" style="margin-right: 5px;">← Previous</button>
                    <button onclick="nextPage('posts')" class="secondary">Next →</button>
                </div>
                
                <div id="postsResponse" class="response"></div>
            </div>
            
            <div class="card">
                <h2>News Feed</h2>
                <div style="margin: 10px 0; display: flex; gap: 10px; align-items: center;">
                    <span>Page:</span>
                    <input type="number" id="feedPage" value="1" min="1" style="width: 60px;">
                    <span>Limit:</span>
                    <input type="number" id="feedLimit" value="10" min="1" max="50" style="width: 60px;">
                    <button onclick="getNewsFeed()">Get My Feed</button>
                </div>

                <div style="margin: 5px 0;">
                    <button onclick="previousPage('posts')" class="secondary" style="margin-right: 5px;">← Previous</button>
                    <button onclick="nextPage('posts')" class="secondary">Next →</button>
                </div>

                <div id="feedResponse" class="response"></div>
            </div>

            <div class="card">
                <h2>Comments & Likes</h2>
                <input type="number" id="postIdForComment" placeholder="Post ID">
                <textarea id="commentContent" placeholder="Your comment" rows="2"></textarea>
                <button onclick="addComment()">Add Comment</button>
                
                <input type="number" id="postIdForLike" placeholder="Post ID">
                <button onclick="likePost()">Like/Unlike</button>
                
                <button onclick="getComments()" class="secondary">Get Comments</button>
                <div id="commentsResponse" class="response"></div>
            </div>
        </div>
    </div>

    <script>
        let token = '';
        let currentUser = null;

        const API_BASE = '/api';

        async function makeRequest(url, method, body = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };
        
            if (token) {
                options.headers['Authorization'] = `Bearer ${token}`;
            }
        
            if (body) {
                options.body = JSON.stringify(body);
            }
        
            try {
                const response = await fetch(`${API_BASE}${url}`, options);
                const data = await response.json();
                
                // FIX: Return the data directly, don't wrap it in another object
                return data;
                
            } catch (error) {
                return { 
                    success: false, 
                    error: error.message 
                };
            }
        }

        // Display response in any element (IMPROVED)
        function displayResponse(elementId, result) {
            const element = document.getElementById(elementId);
            
            if (result.success) {
                // Success styling
                element.style.borderLeft = '4px solid #10B981';
                element.style.background = '#ECFDF5';
                
                // Clean up the display for success responses
                if (result.data && result.data.token) {
                    element.innerHTML = `
         <strong>Success!</strong>
         Response: ${JSON.stringify({
            success: result.success,
            user: result.data.user,
            token: result.data.token ? '***' + result.data.token.slice(-10) : 'None'
        }, null, 2)}
        `;
                } else {
                    element.innerHTML = `<strong>Success!</strong>\n` + JSON.stringify(result, null, 2);
                }
            } else {
                // Error styling
                element.style.borderLeft = '4px solid #EF4444';
                element.style.background = '#FEF2F2';
                element.innerHTML = `<strong>Error:</strong>\n` + JSON.stringify(result, null, 2);
            }
            
            element.style.display = 'block';
        }

        // Auth functions
        async function register() {
            const userData = {
                username: document.getElementById('regUsername').value,
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPassword').value
            };
            
            const result = await makeRequest('/auth/register', 'POST', userData);
            displayResponse('registerResponse', result);
            
            if (result.success) {
                token = result.data.token;
                currentUser = result.data.user;
                updateUserInfo();
                
                // Show success message
                document.getElementById('registerResponse').innerHTML = 
                    ' Registration successful! Token saved.';
            }
        }

        async function login() {
            const loginData = {
                email: document.getElementById('loginEmail').value,
                password: document.getElementById('loginPassword').value
            };
            
            const result = await makeRequest('/auth/login', 'POST', loginData);
            displayResponse('loginResponse', result);
            
            if (result.success) {
                token = result.data.token;
                currentUser = result.data.user;
                updateUserInfo();
                
                // Show success message
                document.getElementById('loginResponse').innerHTML = 
                    'Login successful! Token saved.';
            }
        }

        function logout() {
            token = '';
            currentUser = null;
            updateUserInfo();
            document.getElementById('loginResponse').innerHTML = 'Logged out';
        }

        function updateUserInfo() {
            const userInfo = document.getElementById('userInfo');
            const currentUserSpan = document.getElementById('currentUser');
            
            if (currentUser) {
                userInfo.style.display = 'block';
                currentUserSpan.textContent = `${currentUser.username} (ID: ${currentUser.id})`;
            } else {
                userInfo.style.display = 'none';
            }
        }

        // User functions
        async function getUserProfile() {
            const userId = document.getElementById('profileUserId').value;
            const result = await makeRequest(`/users/${userId}`, 'GET');
            displayResponse('userProfileResponse', result);
        }

        async function followUser() {
            const userId = document.getElementById('followUserId').value;
            const result = await makeRequest(`/users/${userId}/follow`, 'POST', {});
            displayResponse('userProfileResponse', result);
        }

        // Post functions
        async function createPost() {
            const content = document.getElementById('postContent').value;
            const result = await makeRequest('/posts', 'POST', { content });
            displayResponse('postsResponse', result);
        }

        async function getAllPosts() {
            const page = document.getElementById('postsPage').value || 1;
            const limit = document.getElementById('postsLimit').value || 10;
            const result = await makeRequest(`/posts?page=${page}&limit=${limit}`, 'GET');
            displayResponse('postsResponse', result);
            
            if (result.success && result.pagination) {
                updatePaginationControls('posts', result.pagination);
            }
        }
        
        async function getNewsFeed() {
            const page = document.getElementById('feedPage').value || 1;
            const limit = document.getElementById('feedLimit').value || 10;
            const result = await makeRequest(`/feed?page=${page}&limit=${limit}`, 'GET');
            displayResponse('feedResponse', result);
            
            if (result.success && result.pagination) {
                updatePaginationControls('feed', result.pagination);
            }
        }
        
        // Helper function to update pagination controls
        function updatePaginationControls(type, pagination) {
            const pageInput = document.getElementById(`${type}Page`);
            const limitInput = document.getElementById(`${type}Limit`);
            
            if (pageInput && pagination.current_page) {
                pageInput.value = pagination.current_page;
            }
            
            const responseElement = document.getElementById(`${type}Response`);
            if (responseElement && pagination) {
                const paginationInfo = `
        Pagination Info:
        - Page ${pagination.current_page} of ${pagination.total_pages}
        - Showing ${pagination.limit} of ${pagination.total_items} items
        - ${pagination.has_next ? 'Has next page' : 'No more pages'}
        - ${pagination.has_prev ? 'Has previous page' : 'First page'}
        `;
                responseElement.innerHTML = paginationInfo + '\n' + responseElement.innerHTML;
            }
        }

        // Navigation functions
        function previousPage(type) {
            const pageInput = document.getElementById(`${type}Page`);
            const currentPage = parseInt(pageInput.value) || 1;
            if (currentPage > 1) {
                pageInput.value = currentPage - 1;
                if (type === 'posts') getAllPosts();
                if (type === 'feed') getNewsFeed();
            }
        }
        
        function nextPage(type) {
            const pageInput = document.getElementById(`${type}Page`);
            const currentPage = parseInt(pageInput.value) || 1;
            pageInput.value = currentPage + 1;
            if (type === 'posts') getAllPosts();
            if (type === 'feed') getNewsFeed();
        }

        // Comment & Like functions
        async function addComment() {
            const postId = document.getElementById('postIdForComment').value;
            const content = document.getElementById('commentContent').value;
            const result = await makeRequest(`/posts/${postId}/comments`, 'POST', { content });
            displayResponse('commentsResponse', result);
        }

        async function likePost() {
            const postId = document.getElementById('postIdForLike').value;
            const result = await makeRequest(`/posts/${postId}/like`, 'POST', {});
            displayResponse('commentsResponse', result);
        }

        async function getComments() {
            const postId = document.getElementById('postIdForComment').value;
            const result = await makeRequest(`/posts/${postId}/comments`, 'GET');
            displayResponse('commentsResponse', result);
        }

        // Notification functions
        async function getNotifications() {
            const result = await makeRequest('/notifications', 'GET');
            displayResponse('notificationsResponse', result);
        }
    </script>
</body>
</html>